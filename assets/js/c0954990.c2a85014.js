"use strict";(self.webpackChunkllm_cool_docs=self.webpackChunkllm_cool_docs||[]).push([[10],{8801:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>m});const r=JSON.parse('{"id":"lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c","title":"Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c","description":"Intervl2-8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c?","source":"@site/docs/lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c.md","sourceDirName":"lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f","slug":"/lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c","permalink":"/llm_cool_docs/docs/lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/Intervl2_8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"gguf\u4f7f\u7528mmap\u8fdb\u884c\u9ad8\u6548\u8bfb\u53d6\u548c\u4fdd\u5b58","permalink":"/llm_cool_docs/docs/llama\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/gguf\u4f7f\u7528mmap\u8fdb\u884c\u9ad8\u6548\u8bfb\u53d6\u548c\u4fdd\u5b58"},"next":{"title":"\u901a\u8fc7lmdepoly\u5b66\u4e60Python\u4e2d\u5982\u4f55\u5b9e\u73b0\u6ce8\u518c\u6a21\u5f0f","permalink":"/llm_cool_docs/docs/lmdeploy\u5982\u4f55\u5b9e\u73b0\u7684\uff1f/\u901a\u8fc7lmdepoly\u5b66\u4e60Python\u4e2d\u5982\u4f55\u5b9e\u73b0\u6ce8\u518c\u6a21\u5f0f"}}');var s=o(4848),l=o(8453);const i={},c=void 0,t={},m=[];function a(e){const n={a:"a",code:"code",em:"em",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Intervl2-8B\u6a21\u578b\u7684\u9884\u5904\u7406preprocess\u6709\u4f55\u4e0d\u540c?"}),"\n",(0,s.jsx)(n.p,{children:"Intervl2-8B\u6a21\u578b\u4f1a\u5bf9\u56fe\u7247\u8fdb\u884c\u5207\u56fe\uff0c\u5207\u6210448x448\u7684\u5b50\u56fe\u9001\u5165\u6a21\u578b\u3002\u548cQwenVL\u4e0d\u4e00\u6837\uff0cQwenVL\u53ef\u4ee5\u8f93\u5165\u4efb\u610f\u5927\u5c0f\u56fe\u7247\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u5728~/lmdeploy/vl/model/builder.py\u4e2d\u6839\u636e\u6a21\u578b\u914d\u7f6ehf_config\uff0c\u83b7\u53d6model\u6a21\u5757\uff0c\u8c03\u7528\u9884\u5904\u7406build_preprocessor\u51fd\u6570\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"_, hf_config = get_model_arch(model_path)\nkwargs = dict(model_path=model_path,\n                with_llm=with_llm,\n                max_memory=max_memory,\n                hf_config=hf_config,\n                backend=backend)\nfor name, module in VISION_MODELS.module_dict.items():\n    try:\n        if module.match(hf_config):\n            logger.info(f'matching vision model: {name}')\n            model = module(**kwargs)\n            model.build_preprocessor()\n            # build the vision part of a VLM model when backend is\n            # turbomind, or load the whole VLM model when `with_llm==True`\n            if backend == 'turbomind' or with_llm:\n                model.build_model()\n            return model\n    except Exception as e:\n        logger.error(f'build vision model {name} failed, {e}')\n        raise\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u67e5\u770bhf_config\uff0c\u6a21\u578b\u914d\u7f6e\u4fe1\u606f\u3002get_model_arch\u51fd\u6570\u4e2d\u7684\u903b\u8f91\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from transformers import AutoConfig\n\nmodel_path = "/workspace/lm_deploy_repos/InternVL2-8B"\ncfg = AutoConfig.from_pretrained(model_path,trust_remote_code=True)\n_cfg = cfg.to_dict()\nprint(_cfg)\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\uff0c\u90e8\u5206\u6253\u5370\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"'use_backbone_lora': 0, 'use_llm_lora': 0, 'select_layer': -1, 'force_image_size': 448, 'downsample_ratio': 0.5, 'template': 'internlm2-chat', 'dynamic_image_size': True, 'use_thumbnail': True, 'ps_version': 'v2', 'min_dynamic_patch': 1, 'max_dynamic_patch': 12}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.em,{children:"~/lmdeploy/vl/model/internvl.py"}),"\u4e2d\uff0c\u5982\u679c'dynamic_image_size': True\uff0c\u5c31\u4f1a\u8d70v2\u7684\u524d\u5904\u7406\u903b\u8f91\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"if dynamic_image_size or image_processor is None:\n    logger.info('using InternVL-Chat-V1-5 vision preprocess')\n    MEAN = (0.485, 0.456, 0.406)\n    STD = (0.229, 0.224, 0.225)\n    import torchvision.transforms as T\n    from torchvision.transforms.functional import InterpolationMode\n    input_size = self.config.vision_config.image_size\n    self.transform = T.Compose([\n        T.Lambda(lambda img: img.convert('RGB')\n                    if img.mode != 'RGB' else img),\n        T.Resize((input_size, input_size),\n                    interpolation=InterpolationMode.BICUBIC),\n        T.ToTensor(),\n        T.Normalize(mean=MEAN, std=STD)\n    ])\n    self.processor = self._preprocess_v1_5\n    self._forward_func = self._forward_v1_5\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"def _preprocess_v1_5(self, image, params=None):\n    image_res = {'low': 6, 'medium': 12, 'high': 24}\n    max_num = params.get('max_dynamic_patch')\n    if max_num is None or not isinstance(max_num, int):\n        res_key = params.get('detail', 'default')\n        max_num = image_res.get(res_key, self.config.max_dynamic_patch)\n    out = dynamic_preprocess(\n        image,\n        min_num=self.config.min_dynamic_patch,\n        max_num=max_num,\n        image_size=self.config.vision_config.image_size,\n        use_thumbnail=self.config.use_thumbnail)\n    pixel_values = [self.transform(x) for x in out]\n    # (patch) x c x h x w\n    pixel_values = torch.stack(pixel_values)\n    return pixel_values\n"})}),"\n",(0,s.jsxs)(n.p,{children:["dynamic_preprocess\u51fd\u6570\u5728",(0,s.jsx)(n.a,{href:"https://www.modelscope.cn/models/OpenGVLab/InternVL2-8B/summary",children:"InternVL2-8B/summary"}),"\u8fd9\u91ccInference with Transformers\u5c0f\u8282\u4e5f\u6709\u4ecb\u7ecd\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u548cQwenVL\u4e0d\u4e00\u6837\uff0cQwenVL\u53ef\u4ee5\u8f93\u5165\u4efb\u610f\u5927\u5c0f\u56fe\u7247\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u591a\u6a21\u6001\u5927\u6a21\u578b\u5904\u7406\u56fe\u50cf\u65f6",(0,s.jsx)(n.strong,{children:"\u5c06\u56fe\u50cf\u5207\u5206\u6210\u591a\u4e2a448*448\u7684\u5b50\u56fe"}),"\uff0c",(0,s.jsx)(n.strong,{children:"\u6bcf\u4e2a448*448\u7684\u5b50\u56fe\u662fx\u4e2atoken\uff0c\u5b50\u56fe\u5207\u5206\u89c4\u5219\uff1a"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u56fe\u50cf\u5bbd\u4e3a ",(0,s.jsx)(n.code,{children:"width"}),"\u3001\u56fe\u50cf\u9ad8\u4e3a ",(0,s.jsx)(n.code,{children:"height"}),"\u3001\u56fe\u50cf\u5bbd\u5207\u5206\u5757\u6570 ",(0,s.jsx)(n.code,{children:"m"}),"\u3001\u56fe\u50cf\u9ad8\u5207\u5206\u5757\u6570",(0,s.jsx)(n.code,{children:"n"}),"\u3001\u6700\u5927\u5207\u5206\u5757\u6570 ",(0,s.jsx)(n.code,{children:"block_count_max"}),"\u3001\u6700\u5c0f\u5207\u5206\u5757\u6570 ",(0,s.jsx)(n.code,{children:"block_count_min"}),"\uff0c\u5207\u5206\u7684 ",(0,s.jsx)(n.code,{children:"m"}),"\u3001",(0,s.jsx)(n.code,{children:"n"})," \u540c\u65f6\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"block_count_min <= m * n <= block_count_max"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"m / n"}),"\u4e0e ",(0,s.jsx)(n.code,{children:"width / height"}),"\u7684\u5dee\u503c\u6700\u5c0f"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["token\u8ba1\u7b97\u516c\u5f0f\uff1a",(0,s.jsx)(n.code,{children:"token = m * n * x"})]}),"\n",(0,s.jsxs)(n.p,{children:["lmdeploy\u4e2d\u5b9e\u73b0\u5728",(0,s.jsx)(n.a,{href:"https://github1s.com/InternLM/lmdeploy/blob/main/lmdeploy/vl/model/internvl.py",children:"model/internvl.py"}),"\u3002"]})]})}function d(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>c});var r=o(6540);const s={},l=r.createContext(s);function i(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);